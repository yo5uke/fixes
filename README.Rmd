---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.path = "man/figures/README-",
  fig.width = 8,
  fig.height = 5,
  dpi = 300
)

# Load the development version of the package
devtools::load_all()
```

# fixes <a><img src="man/figures/fixes_logo_blue.png" align="right" height="138" width="120" /></a>


<!-- badges: start -->
```{r badges, include=FALSE}
rcompendium::add_cran_badge(quiet = FALSE)
```
[![CRAN status](https://www.r-pkg.org/badges/version/fixes)](https://CRAN.R-project.org/package=fixes)
[![R-CMD-check](https://github.com/yo5uke/fixes/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/yo5uke/fixes/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

## Overview

> **Current version:** 0.7.1

> **Note**  
> By default, the `fixes` package assumes time is a regularly spaced numeric variable (e.g., year = 1995, 1996, ...).  
> If your time variable is irregular or non-numeric (e.g., `Date` type), set `time_transform = TRUE` to automatically convert it to a sequential index within each unit.  
> For unit-specific treatment timing, set `staggered = TRUE`.

The `fixes` package is designed for convenient event study analysis and plotting, particularly useful for visualizing parallel trends and dynamic effects in two-way fixed effects (TWFE) difference-in-differences (DID) research.

**Key Functions:**

1. `run_es()` â€” Takes a data frame, generates lead/lag dummies, and fits the event study regression. Supports fixed effects, covariates, clustering, staggered timing, weights, custom baseline, and multiple confidence intervals.
2. `plot_es()` â€” Plots event study results using `ggplot2` with flexible options: ribbon or error bars, choice of CI level, and theme customization.
3. `plot_es_interactive()` â€” Creates interactive event study plots using `plotly` with hover tooltips displaying coefficients, confidence intervals, standard errors, and p-values.

## Installation

Install from CRAN:

```r
install.packages("fixes")
```

Or with **pak**:

```r
pak::pak("fixes")
```

For the latest development version from GitHub:

```r
pak::pak("yo5uke/fixes")
```

## How to use

First, load the library.

```{r load-library, eval=FALSE}
library(fixes)
```

### Data frame requirements

`run_es()` expects a panel data frame with at least:

- Unit identifier (e.g., individual, firm, region)
- Treatment indicator (0/1 or TRUE/FALSE)
- Time variable (numeric or `Date`)
- Outcome variable (continuous)

For **staggered adoption** (`staggered = TRUE`), include a variable specifying unit-specific treatment timing (e.g., "treatment_year").

#### Example data

Widely used panel datasets include:

- `did::sim_dt()`: simulated panel for DiD tutorials
- `fixest::base_stagg`: a built-in dataset for staggered adoption

```{r load-data}
df1 <- fixest::base_did      # Basic DiD
df2 <- fixest::base_stagg    # Staggered treatment
```

```{r show-data, echo=FALSE}
head(df1) |>
  knitr::kable()
head(df2) |>
  knitr::kable()
```

### `run_es()`

The main event study function. All key arguments below:

| Argument        | Description |
|-----------------|-------------|
| `data`          | Data frame to be used. |
| `outcome`       | Outcome variable. Can be specified as a raw variable or a transformation (e.g., `log(y)`). Provide it unquoted. |
| `treatment`     | Dummy variable indicating the treated units. Provide it unquoted. Accepts both `0/1` and `TRUE/FALSE`. |
| `time`          | Time variable. Provide it unquoted. |
| `timing`        | The time at which the treatment occurs. If `staggered = FALSE`, this should be a scalar (e.g., `2005`). If `staggered = TRUE`, provide a variable (column) indicating the treatment time for each unit. |
| `fe`            | Fixed effects to control for unobserved heterogeneity. **Must be a one-sided formula** (e.g., `~ id + year`). |
| `lead_range`    | Number of pre-treatment periods to include (e.g., 3 = `lead3`, `lead2`, `lead1`). Default is `NULL`, which automatically uses the maximum available lead range. |
| `lag_range`     | Number of post-treatment periods to include (e.g., 2 = `lag0` (the treatment period), `lag1`, `lag2`). Default is `NULL`, which automatically uses the maximum available lag range. |
| `covariates`    | Additional covariates to include in the regression. **Must be a one-sided formula** (e.g., `~ x1 + x2`). |
| `cluster`       | Specifies clustering for standard errors. Can be a **character vector** (e.g., `c("id", "year")`) or a **formula** (e.g., `~ id + year`, `~ id^year`). |
| `weights`       | Optional weights to be used in the regression. Provide as a one-sided formula (e.g., `~ weight`). |
| `baseline`      | Relative time value to be used as the reference category (default: `-1`). For both `classic` and `sunab` methods, this period is included in results with zero estimates. **Must be within the specified lead/lag range.** |
| `interval`      | Time interval between observations (e.g., `1` for yearly data, `5` for 5-year intervals). |
| `time_transform`| Logical. If `TRUE`, converts the `time` variable into a sequential index (1, 2, 3, ...) within each unit. Useful for irregular time (e.g., Date). Default is `FALSE`. |
| `unit`          | Required if `time_transform = TRUE`. Specifies the panel unit identifier (e.g., `firm_id`). |
| `staggered`     | Logical. If `TRUE`, allows for unit-specific treatment timing (staggered adoption). Default is `FALSE`. |
| `method`        | Estimation method: `"classic"` (default) uses factor expansion with `fixest::i()`, or `"sunab"` for staggered-robust estimation using Sun & Abraham (2021) decomposition. |
| `conf.level`    | Numeric vector of confidence levels (e.g., `c(0.90, 0.95, 0.99)`; default: `0.95`). |
| `vcov`          | Variance-covariance type (default: `"HC1"`). Accepts any `fixest::vcov()` type (e.g., `"HC3"`, `"CR2"`, `"iid"`). |

#### Example: basic event study

```{r basic-event-study}
event_study <- run_es(
  data       = df1,
  outcome    = y,
  treatment  = treat,
  time       = period,
  timing     = 5,  # Treatment occurs at period 5
  fe         = ~ id + period,
  lead_range = 3,
  lag_range  = 3,
  cluster    = ~ id,
  baseline   = -1,
  interval   = 1,
  conf.level = c(0.90, 0.95, 0.99)
)

# View summary
print(event_study)
```

- `fe` must be a one-sided formula (e.g., `~ firm_id + year`).
- `cluster` can be a one-sided formula or a character vector.

### Plotting Results

#### Example usage

```{r plot-basic}
# Basic plot with ribbon (default: 95% CI)
plot_es(event_study)
```

```{r plot-errorbar}
# Plot with error bars
plot_es(event_study, type = "errorbar", ci_level = 0.95)
```

```{r plot-custom}
# Customized plot
plot_es(event_study, type = "ribbon", ci_level = 0.99, theme_style = "minimal") +
  ggplot2::ggtitle("Event Study: 99% Confidence Interval")
```

### Staggered Treatment with `sunab`

For staggered adoption designs with unit-varying treatment timing, use `method = "sunab"` for the Sun & Abraham (2021) estimator:

```{r sunab-example}
# Using fixest::base_stagg example data
event_study_sunab <- run_es(
  data       = df2,
  outcome    = y,
  treatment  = treated,
  time       = year,
  timing     = year_treated,
  fe         = ~ id + year,
  staggered  = TRUE,
  method     = "sunab",
  lead_range = 3,
  lag_range  = 3,
  cluster    = ~ id
)

# View summary
print(event_study_sunab)
```

```{r plot-sunab}
# Plot sunab results
plot_es(event_study_sunab)
```

**Note (v0.7.1+):** The `baseline` parameter now works for both `classic` and `sunab` methods, and results are properly filtered to `lead_range` and `lag_range`.

### Interactive Plots

Create interactive event study plots with hover tooltips (requires the `plotly` package):

```{r plot-interactive, eval=FALSE}
# Interactive plot with hover information
plot_es_interactive(event_study, ci_level = 0.95)
```

Hover over points to see relative time, point estimates, confidence intervals, standard errors, and p-values.

## Planned Features

- Support for `staggered = TRUE` with `time_transform = TRUE`
- Allow `timing` to accept original time values (e.g., `Date`), not just index

## Debugging and Contributions

If you find an issue or want to contribute, please use the [GitHub Issues page](https://github.com/yo5uke/fixes/issues).

---

Happy analyzing!ðŸ¥‚
