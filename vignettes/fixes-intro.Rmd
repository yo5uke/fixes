---
title: "Introduction to fixes"
author: "Yosuke Abe"
date: "`r Sys.setlocale('LC_TIME', 'C'); format(Sys.Date(), '%B %d, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to fixes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

The **fixes** package provides an easy-to-use toolkit for creating, estimating, and visualizing event study models using fixed effects regression. With **fixes**, you can automatically generate lead and lag dummy variables, flexibly estimate fixed effects event study regressions, and visualize the results with `ggplot2` using a single pipeline.

This vignette introduces the core functions of the package through simple examples, including recent updates such as multiple confidence interval support, improved plotting options, and **new in version 0.7.0**: interactive plotly visualizations with dynamic confidence interval switching.

## Installation

Install the released version from CRAN:

```r
install.packages("fixes")
```

Or with **pak** (recommended for fast install):

```r
pak::pak("fixes")
```

To install the latest development version from GitHub:

```r
pak::pak("yo5uke/fixes")
```

or

```r
devtools::install_github("yo5uke/fixes")
```

## Minimal Example

Below is a basic example simulating a panel dataset, running an event study, and visualizing the results.

```r
library(fixes)
library(dplyr)
library(tibble)

set.seed(2)

n_firms <- 1000
n_states <- 50
T <- 36

firm_id <- 1:n_firms
state_id <- sample(n_states, size = n_firms, replace = TRUE)
year <- 1980:2015

fe_firm <- rnorm(n_firms, mean = 0, sd = .5)
fe_year <- rnorm(T, mean = 0, sd = .5)
error <- rnorm(n_firms * T, mean = 0, sd = .5)

treated_1998 <- sample(c(1, 0), size = n_firms,
                       replace = TRUE, prob = c(1/2, 1/2))

df <- tibble(
  firm_id = rep(firm_id, each = T),
  state_id = rep(state_id, each = T),
  year = rep(year, times = n_firms),
  fe_firm = rep(fe_firm, each = T),
  fe_year = rep(fe_year, times = n_firms),
  error = error,
  is_treated = rep(treated_1998, each = T),
  after_treat = if_else(is_treated == 1 & year >= 1998, 1, 0),
  x1 = runif(n_firms * T),
  x2 = rnorm(n_firms * T),
  y = case_when(
    after_treat == 1 ~
      rnorm(n_firms * T, mean = .3, sd = .2) * (year - 1997) + fe_firm + fe_year + error,
    TRUE ~ fe_firm + fe_year + error
  )
)

# Run the event study (now supports multiple confidence levels)
event_study <- run_es(
  data       = df,
  outcome    = y,
  treatment  = is_treated,
  time       = year,
  timing     = 1998,
  lead_range = 18,
  lag_range  = 17,
  covariates = ~ x1 + x2,
  fe         = ~ firm_id + year,
  cluster    = ~ state_id,
  baseline   = -1,
  interval   = 1,
  conf.level = c(0.90, 0.95, 0.99) # Multiple CIs now supported!
)

# View results
head(event_study)
```

## Visualizing Event Study Results

The **fixes** package provides `plot_es()` for flexible visualization. You can easily switch between ribbon-style or error bar CIs, select the displayed CI level, and customize appearance.

```r
# Basic plot (default: ribbon, 95% CI)
p1 <- plot_es(event_study)
print(p1)

# Plot with error bars and 99% CI
p2 <- plot_es(event_study, type = "errorbar", ci_level = 0.99)
print(p2)

# Use a minimal theme and highlight the event period
p3 <- plot_es(event_study, type = "ribbon", vline_val = 0, theme_style = "minimal")
print(p3)

# Customize further with ggplot2
library(ggplot2)
p4 <- plot_es(event_study, type = "errorbar", ci_level = 0.9, theme_style = "classic") +
  scale_x_continuous(breaks = seq(-10, 10, by = 2)) +
  ggtitle("Event Study with 90% CI and Classic Theme")
print(p4)
```

## Interactive Plotting (New in v0.7.0!)

The **fixes** package now includes `plot_es_interactive()` for creating interactive plotly visualizations. This feature requires the `plotly` package:

```r
# Install plotly if not already installed
if (!requireNamespace("plotly", quietly = TRUE)) {
  install.packages("plotly")
}
```

### Key Features of Interactive Plots

Interactive plots provide several advantages for exploring event study results:

1. **Dynamic CI Switching**: Toggle between 90%, 95%, and 99% confidence intervals using interactive buttons
2. **Hover Tooltips**: View detailed information by hovering over any point:
   - Relative time to treatment
   - Point estimate (4 decimal precision)
   - Confidence interval bounds
   - P-value
   - Sample size
3. **Zoom and Pan**: Explore specific regions of your plot with built-in plotly tools
4. **Legend Toggle**: Click legend items to show/hide specific elements

### Multiple Confidence Intervals by Default

Starting with version 0.7.0, `run_es()` calculates 90%, 95%, and 99% confidence intervals by default. This enables interactive CI switching without re-running the estimation. The calculations are vectorized, so there's no performance penalty.

```r
# The event_study object created earlier already has multiple CIs
print(event_study)
#> Event Study Result (fixes)
#>   N: 36000  | Units: NA  | Treated units: 18000  | Never-treated: NA
#>   FE: firm_id + year
#>   VCOV: HC1  | Cluster: state_id
#>   Method: classic  | lead_range: 18  lag_range: 17  baseline: -1
#>   Note: Multiple confidence levels calculated (90%, 95%, 99%).
#>         Use plot_es_interactive() for dynamic CI switching.
```

### Creating Interactive Plots

Basic usage is straightforward:

```r
# Create interactive plot (starts with 95% CI by default)
plot_es_interactive(event_study)
```

This creates an interactive visualization with:
- Three buttons at the top to switch between 90%, 95%, and 99% CIs
- Smooth ribbon display showing the confidence interval
- Points connected by a line showing point estimates
- Dashed reference lines at x=0 (event time) and y=0 (no effect)

### Customization Options

The interactive plot function supports similar customization as `plot_es()`:

```r
# Start with 90% CI
plot_es_interactive(event_study, conf.level = 0.90)

# Use errorbar style instead of ribbon
plot_es_interactive(event_study, display_type = "errorbar")

# Apply minimal theme
plot_es_interactive(event_study, theme = "minimal")

# Full customization
plot_es_interactive(
  event_study,
  conf.level = 0.95,
  display_type = "ribbon",
  theme = "bw",
  color = "#E64B35",      # Custom color
  fill = "#E64B35",       # Custom fill
  alpha = 0.3,            # Transparency
  linewidth = 1.5,        # Thicker line
  pointsize = 3           # Larger points
)
```

### Understanding the Interactive Controls

When you create an interactive plot, you'll see several interactive features:

1. **CI Level Buttons** (top of plot): Click "90%", "95%", or "99%" to switch between confidence intervals. The plot title and data update automatically.

2. **Hover Tooltips**: Move your mouse over any point to see:
   ```
   Relative Time: -5
   Estimate: 0.1234
   CI: [-0.0567, 0.3035]
   P-value: 0.182
   N: 36000
   ```

3. **Zoom Tools** (modebar, top-right):
   - Box zoom: Click and drag to zoom into a specific region
   - Pan: Click the pan tool, then drag to move around
   - Reset axes: Return to original view
   - Download plot: Save as PNG

4. **Legend**: Click legend items to show/hide elements (useful for presentations)

### Comparing with Static Plots

Both `plot_es()` and `plot_es_interactive()` use the same data and styling. Choose based on your needs:

**Static plots (`plot_es()`)** are best for:
- Publications and papers (standardized output)
- Further customization with ggplot2
- Faster rendering for quick checks
- PDF exports

**Interactive plots (`plot_es_interactive()`)** excel at:
- Exploratory data analysis
- Presentations and talks
- Sharing results with collaborators
- Exploring different CI levels dynamically

```r
# Side-by-side comparison
static_plot <- plot_es(event_study, ci_level = 0.95)
interactive_plot <- plot_es_interactive(event_study, conf.level = 0.95)

# Display static plot
print(static_plot)

# Display interactive plot (if in RStudio or browser)
interactive_plot
```

### Example: Focused Analysis

Interactive plots are particularly useful for examining specific time windows:

```r
# Create interactive plot, then zoom to specific region
# Users can interactively zoom to periods -5 to +10
plot_es_interactive(
  event_study,
  display_type = "errorbar",
  theme = "classic"
)
```

After creating the plot, you can:
1. Use box zoom to focus on periods -5 to +10
2. Switch between CI levels to see how inference changes
3. Hover over points near the event time (0) to examine estimates precisely

## Handling Irregular Time Data

If your panel data uses irregular time variables (e.g., Dates), or has gaps, set `time_transform = TRUE` and provide a `unit` variable. This will replace the time variable with a consecutive sequence within each unit, ensuring leads/lags are calculated correctly.

### Example using `Date` and `time_transform`

```r
df_alt <- df |>
  mutate(date = as.Date(paste0(year, "-01-01")))

event_study_alt <- run_es(
  data           = df_alt,
  outcome        = y,
  treatment      = is_treated,
  time           = date,
  timing         = 19,        # 19th time point per unit (not the actual year!)
  lead_range     = 3,
  lag_range      = 3,
  fe             = ~ firm_id + year,
  cluster        = ~ state_id,
  baseline       = -1,
  time_transform = TRUE,
  unit           = firm_id
)

head(event_study_alt)
```

**Note:** When `time_transform = TRUE`, use the index (1, 2, 3, ...) for `timing` rather than the actual value (e.g., "1998-01-01"), and always specify `unit`.

## Package Highlights

- **`run_es()`**:
    - Fast, one-step event study for panel data.
    - Automatic creation of lead/lag dummies relative to treatment.
    - Supports both classic and staggered timing, covariates, clustering, weights, and flexible baseline normalization.
    - Multiple confidence interval levels supported (e.g., 90%, 95%, 99%).
    - Handles irregular time panels via `time_transform`.

- **`plot_es()`**:
    - Intuitive event study plot with ribbon or errorbar CI display.
    - CI level and visual style are fully customizable.
    - ggplot2-based for further modification.

- **`plot_es_interactive()`** (new in v0.7.0):
    - Interactive plotly visualization with dynamic CI switching.
    - Hover tooltips display detailed information.
    - Zoom, pan, and legend toggle for exploring results.
    - Perfect for presentations and exploratory analysis.

## Conclusion

The **fixes** package streamlines event study estimation and visualization for panel data researchers. With a minimal API, multiple CI support, and robust visualization, it accelerates the workflow for dynamic treatment effect analysis.

For further details and full argument documentation, see:

```r
?run_es
?plot_es
?plot_es_interactive
```

Happy analyzing!🥂
